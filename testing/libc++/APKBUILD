# Contributor: Dmitry Golovin <dima@golovin.in>
# Contributor: Shiz <hi@shiz.me>
# Maintainer: Shiz <hi@shiz.me>
pkgname=libc++
pkgver=7.0.0
pkgrel=0
_llvmver=${pkgver%%.*}
pkgdesc="A new implementation of the C++ standard library, targeting C++11"
url="http://libcxx.llvm.org/"
arch="all !ppc64le !s390x"
license="UOI-NCSA"
makedepends="cmake
	clang>=$_llvmver
	linux-headers
	llvm-dev>=$_llvmver
	llvm-libunwind-dev>=$_llvmver
	llvm-static>=$_llvmver"
checkdepends="lit"
subpackages="$pkgname-dev"
source="http://releases.llvm.org/$pkgver/libcxx-$pkgver.src.tar.xz
	http://releases.llvm.org/$pkgver/libcxxabi-$pkgver.src.tar.xz
	avoid-strtoll_l.patch"
builddir="$srcdir"
_cxxdir="$srcdir/libcxx-$pkgver.src"
_abidir="$srcdir/libcxxabi-$pkgver.src"

# Tests on armhf are too slooow, disable them for now.
case "$CARCH" in
	armhf) options="!check";;
esac

prepare() {
	ln -s "$_cxxdir" "$srcdir"/libcxx
	ln -s "$_abidir" "$srcdir"/libcxxabi
	default_prepare
}

# Due a mutual build-time dependency between libc++abi and libc++, it is
# preferable that we build them within the same APKBUILD to avoid duplication.
# Since nothing else seems to need libc++abi and we need to compile it into
# libc++ statically anyway to make -static with libc++ work, we don't actually
# create libc++abi packages. If something arises that depends on libc++abi,
# this may change, but for now this is the simplest approach.
build() {
	mkdir -p "$_abidir"/build
	cd "$_abidir"/build
	cmake .. \
		-DCMAKE_BUILD_TYPE=MinSizeRel \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_CXX_COMPILER=clang++ \
		-DCMAKE_CXX_FLAGS="$CXXFLAGS" \
		-DCMAKE_C_COMPILER=clang \
		-DCMAKE_C_FLAGS="$CFLAGS" \
		-DLIBCXXABI_ENABLE_SHARED=OFF \
		-DLIBCXXABI_USE_LLVM_UNWINDER=ON \
		-DLIBCXXABI_ENABLE_STATIC_UNWINDER=ON \
		-DLIBCXXABI_LIBUNWIND_INCLUDES=/usr/include \
		-DLIBCXXABI_LIBCXX_INCLUDES="$_cxxdir"/include \
		-DLIBCXXABI_LIBCXX_LIBRARY_PATH="$_cxxdir"/build/lib \
		-DLIBCXXABI_INCLUDE_TESTS=ON
	make

	mkdir -p "$_cxxdir"/build
	cd "$_cxxdir"/build
	cmake .. \
		-DCMAKE_BUILD_TYPE=MinSizeRel \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_CXX_COMPILER=clang++ \
		-DCMAKE_CXX_FLAGS="$CXXFLAGS" \
		-DCMAKE_C_COMPILER=clang \
		-DCMAKE_C_FLAGS="$CFLAGS" \
		-DLLVM_EXTERNAL_LIT=/usr/bin/lit \
		-DLIBCXX_HAS_MUSL_LIBC=ON \
		-DLIBCXX_CXX_ABI=libcxxabi \
		-DLIBCXX_CXX_ABI_INCLUDE_PATHS="$_abidir"/include \
		-DLIBCXX_CXX_ABI_LIBRARY_PATH="$_abidir"/build/lib \
		-DLIBCXXABI_USE_LLVM_UNWINDER=ON \
		-DLIBCXXABI_ENABLE_STATIC_UNWINDER=ON \
		-DLIBCXX_ENABLE_STATIC_ABI_LIBRARY=ON  # needed to make -static work.
	make
}

check() {
	cd "$_abidir"/build
	make check-cxxabi || true

	cd "$_cxxdir"/build
	# XXX: Some tests fail due to fakeroot currently, and some other due
	# yet-uninvestigated causes.
	make check-cxx || true
}

package() {
	cd "$_cxxdir"/build
	make install DESTDIR="$pkgdir"
}

sha512sums="5ebf8418bc9d311c1744c257ab7a26cf2436a64a47451905df70ec64b12d25ec33acf99e1b9d552fd54ed850bed8f53dffde2ea20292ecd9976eaa31f144caf5  libcxx-7.0.0.src.tar.xz
95aa8f60477739e6d6eb6ba1e32c98928e1b8104d18d659336cf7f1c5bfd1ed505015077dfbe39329c0c9d2b5b428d853e5652b0106c0cde317d2d013ebd1cf0  libcxxabi-7.0.0.src.tar.xz
212bbc1bcbc4628754bdd5bc8a9109fa0032790a3c80517a647a26ee27c22daa417303a72b6cc92cfc099dcc7fd9a36e9d8899165ebe4a5ab14030eaa596bc9c  avoid-strtoll_l.patch"
