# Contributor Travis Tilley <ttilley@gmail.com>
# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=compiler-rt
# Note: Update together with llvm.
pkgver=7.0.0
pkgrel=0
_llvmver=${pkgver%%.*}
pkgdesc="LLVM compiler-rt runtime libraries"
arch="all !ppc64le !s390x"
url="http://llvm.org/"
license="UOI-NCSA"
makedepends_build="clang cmake ninja python2"
makedepends_host="linux-headers llvm-dev>=$_llvmver llvm-static>=$_llvmver"
checkdepends="llvm-test-utils>=$_llvmver"
source="https://llvm.org/releases/$pkgver/compiler-rt-$pkgver.src.tar.xz"
builddir="$srcdir/$pkgname-$pkgver.src"

build() {
	mkdir -p "$builddir"/build
	cd "$builddir"/build

	# compiler-rt uses llvm intrinsic types for testing
	# and therefore requires clang
	cmake -Wno-dev -G Ninja \
		-DCMAKE_C_COMPILER=clang \
		-DCMAKE_CXX_COMPILER=clang++ \
		\
		-DCMAKE_BUILD_TYPE=MinSizeRel \
		-DCMAKE_C_FLAGS_MINSIZEREL_INIT="$CFLAGS" \
		-DCMAKE_CXX_FLAGS_MINSIZEREL_INIT="$CXXFLAGS" \
		-DCMAKE_EXE_LINKER_FLAGS_MINSIZEREL_INIT="$LDFLAGS" \
		-DCMAKE_INSTALL_PREFIX=/usr \
		\
		-DCOMPILER_RT_INCLUDE_TESTS=OFF \
		-DCOMPILER_RT_BUILD_SANITIZERS=OFF \
		-DCOMPILER_RT_BUILD_XRAY=OFF \
		-DLLVM_EXTERNAL_LIT="/usr/bin/lit" \
		"$builddir"

	ninja
}

check() {
	cd "$builddir"/build
	# remove test that does not work with PaX kernel
	#rm ../test/builtins/Unit/enable_execute_stack_test.c \
	#	../test/builtins/Unit/clear_cache_test.c
	#ninja check-compiler-rt
}

package() {
	cd "$builddir"/build
	export DESTDIR="$pkgdir"

	ninja install

	cd "$pkgdir"

	mkdir -p usr/lib/clang/$pkgver/lib
	case "$CARCH" in
		ppc64le | s390x) ;;
		*) mv usr/lib/linux usr/lib/clang/$pkgver/lib;;
	esac
}

sha512sums="fb36aab38e7b7e3c23ad8598a54a5d7d36a30bc306c60c95b074029ffad48cb1d74fa5acde34b4affc50827562fd794969ae31067bd64e116281eb65ae4f4346  compiler-rt-7.0.0.src.tar.xz"
