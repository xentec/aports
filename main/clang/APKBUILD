# Contributor Travis Tilley <ttilley@gmail.com>
# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=clang
# Note: Update together with llvm.
pkgver=7.0.0
pkgrel=0
_llvmver=${pkgver%%.*}
pkgdesc="A C language family front-end for LLVM"
arch="all"
url="http://llvm.org/"
license="UOI-NCSA"
makedepends_build="cmake libxml2-utils llvm-test-utils>=$_llvmver ninja python3"
makedepends_host="isl-dev libedit-dev libxml2-dev llvm-dev>=$_llvmver llvm-static>=$_llvmver"
depends_dev="$pkgname=$pkgver-r$pkgrel"
subpackages="$pkgname-static $pkgname-dev $pkgname-doc $pkgname-libs $pkgname-analyzer::noarch"
source="https://llvm.org/releases/$pkgver/cfe-$pkgver.src.tar.xz
	
	0001-Enable-stack-protector-by-default-for-Alpine-Linux.patch
	0002-Fix-ClangConfig.patch
	"

builddir="$srcdir/cfe-$pkgver.src"

build() {
	mkdir -p "$builddir"/build
	cd "$builddir"/build

	cmake -Wno-dev -G Ninja \
		-DCMAKE_BUILD_TYPE=MinSizeRel \
		-DCMAKE_C_FLAGS_MINSIZEREL_INIT="$CFLAGS" \
		-DCMAKE_CXX_FLAGS_MINSIZEREL_INIT="$CXXFLAGS" \
		-DCMAKE_EXE_LINKER_FLAGS_MINSIZEREL_INIT="$LDFLAGS" \
		-DCMAKE_INSTALL_PREFIX=/usr \
		\
		-DCLANG_VENDOR="Alpine" \
		-DCLANG_BUILD_EXAMPLES=OFF \
		-DCLANG_INCLUDE_DOCS=ON \
		-DCLANG_INCLUDE_TESTS=ON \
		-DCLANG_PLUGIN_SUPPORT=ON \
		-DLIBCLANG_BUILD_STATIC=ON \
		-DLLVM_ENABLE_EH=ON \
		-DLLVM_ENABLE_RTTI=ON \
		-DLLVM_EXTERNAL_LIT="/usr/bin/lit" \
		-DLLVM_LINK_LLVM_DYLIB=ON \
		"$builddir"

	ninja
}

check() {
	cd "$builddir"/build

	ninja check-clang
}

package() {
	cd "$builddir"/build
	export DESTDIR="$pkgdir"

	ninja install
	install -m 644 lib/libclang.a "$pkgdir"/usr/lib
}

static() {
	pkgdesc="Static libraries for clang"

	mkdir -p "$subpkgdir"/usr/lib
	mv "$pkgdir"/usr/lib/*.a "$subpkgdir"/usr/lib/
}

analyzer() {
	pkgdesc="Clang source code analysis framework"
	depends="$pkgname=$pkgver-r$pkgrel perl python3"

	cd "$pkgdir"

	mkdir -p "$subpkgdir"/usr/bin \
		"$subpkgdir"/usr/libexec \
		"$subpkgdir"/usr/share/
	mv usr/bin/scan-* "$subpkgdir"/usr/bin/
	mv usr/libexec/*-analyzer "$subpkgdir"/usr/libexec/
	mv usr/share/scan-* "$subpkgdir"/usr/share/
}

sha512sums="17a658032a0160c57d4dc23cb45a1516a897e0e2ba4ebff29472e471feca04c5b68cff351cdf231b42aab0cff587b84fe11b921d1ca7194a90e6485913d62cb7  cfe-7.0.0.src.tar.xz
246c24b100fab09876e55e17d71bae69dd4ef26f34aefc4437382580345b3f17e30ceb3e95b9f6607ece4ce593d1e21e336489a8655cdbf69d51bc1c22fc0402  0001-Enable-stack-protector-by-default-for-Alpine-Linux.patch
822ed7393144bff52327db68efa63028f5aa792fd6a80d8cb37cbeb6bda8c30c69a77d04b33f40c1cd712e40e2480dcc7b81c9354dc9eef7c46a93a60d3c8b95  0002-Fix-ClangConfig.patch"
