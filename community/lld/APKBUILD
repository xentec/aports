# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=lld
pkgver=7.0.0
pkgrel=0
_llvmver=${pkgver%%.*}
pkgdesc="The LLVM Linker"
url="http://llvm.org"
arch="all"
license="UOI-NCSA"
makedepends_build="cmake ninja llvm-test-utils>=$_llvmver"
makedepends_host="libedit-dev llvm-dev>=$_llvmver llvm-static>=$_llvmver zlib-dev"
checkdepends="gtest gtest-dev"
subpackages="$pkgname-dev $pkgname-libs"
source="https://llvm.org/releases/$pkgver/$pkgname-$pkgver.src.tar.xz"
builddir="$srcdir/$pkgname-$pkgver.src"

build() {
	mkdir -p "$builddir"/build
	cd "$builddir"/build

	cmake -Wno-dev -G Ninja \
		-DCMAKE_BUILD_TYPE=MinSizeRel \
		-DCMAKE_VERBOSE_MAKEFILE=OFF \
		-DCMAKE_C_FLAGS_MINSIZEREL_INIT="$CFLAGS" \
		-DCMAKE_CXX_FLAGS_MINSIZEREL_INIT="$CXXFLAGS" \
		-DCMAKE_EXE_LINKER_FLAGS_MINSIZEREL_INIT="$LDFLAGS" \
		-DCMAKE_INSTALL_PREFIX=/usr \
		\
		-DCMAKE_SKIP_INSTALL_RPATH=ON \
		-DLLVM_INCLUDE_TESTS=ON \
		-DLLVM_EXTERNAL_LIT=/usr/bin/lit \
		-DLLVM_LINK_LLVM_DYLIB=ON \
		-DBUILD_SHARED_LIBS=ON \
		"$builddir"

	ninja
}

check() {
	cd "$builddir/build"
	# enable if tests on armhf are still failing
#	[ "$CARCH" = "armhf" ] && return 0
	ninja check-lld
}

package() {
	cd "$builddir"/build
	export DESTDIR="$pkgdir"

	ninja install 
}

sha512sums="14f34557d8b72b252632e7aae2e0c0551b829026a152659cc290ead68d5944a7ffb1906af95b9265228fee2b45cc561c6261cc56bb1bd61dca01149e80ca9d56  lld-7.0.0.src.tar.xz"
